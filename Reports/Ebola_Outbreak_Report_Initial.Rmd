---
title: "Situational report on the Ebola Virus Disease (EVD) outbreak in southwest Uganda"
author: "Roxanne Beauclair and Ivy Kombe"
date: "`r lubridate::today()`"
output:
  html_document:
    highlight: tango
    theme: lumen
    toc: yes
    toc_depth: 5
references:
- id: whoresponseteam
  title: Ebola Virus Disease in West Africa â€” The first 9 Months of the Epidemic and Forward Projections
  author: 
  - family: WHO Ebola Response Team
  volume: 371
  issue: 16
  page: 1481-1495
  type: article-journal
  publisher: New England Journal of Medicine
  issued:
    year: 2014
    month: 10
---

```{r setup, include = FALSE}
# ============
# Set options
# ===========

knitr::opts_chunk$set(warning = FALSE)
knitr::opts_chunk$set(message = FALSE)
knitr::opts_chunk$set(echo = FALSE)

options(table_counter = TRUE)
options(table_counter_str = "<b>Table %s:</b> ")

# ===================
# File paths
# ===================
wd <- "/Users/roxannebeauclair/Dropbox/Work/Work for SACEMA-Juliet/Rapid Response Team/Challenge Assignment/Analysis"
# wd <- "../../../GitHub/Ebola_Outbreak_Uganda_Challenge/"
rdata <- paste0(wd, "/Data/Raw") 
cdata <- paste0(wd, "/Data/Cleaned")

updatedf <- paste0(cdata, "/Updated_ebola.rda")


# ====================
# Loading dependencies
# ====================
library(R0)
library(incidence)
library(tidyverse)
library(lubridate)
library(scales)
library(janitor)
library(htmlTable)


# =============
# Load datasets
# =============
load(updatedf)
```

# **Overview**

<br>
<br>

```{r hightlights_setup, include = FALSE}

total_cases <- nrow(ebola_df)
earliest_date <- min(ebola_df$onsetDate) %>% format(format = "%d %b, %Y")
latest_date <- max(ebola_df$onsetDate) %>% format(format = "%d %b, %Y")

count_status <- ebola_df %>%
  count(status)

```

This report contains information about the baseline EVD situation in Uganda. The results from this report are based upon the best information that is currently available. As more data is collected, the report will be updated. Over a period of five months, from `r earliest_date` to `r latest_date`, there have been `r total_cases` reported cases of EVD from a community of 400 people.  Of the `r total_cases` reported cases, `r count_status$n[1]` were confirmed, `r count_status$n[2]` were probable,  and `r count_status$n[3]` suspected. 

<br>

# **Visualisation and summary statistics**
<br>

The following figures show the weekly incidence over the 2019 calendar year. The incidence is presented by both case definition and the outcome of the case (recovered / died). The different case types are definied in the following way, according to the @whoresponseteam: "A suspected case is illness in any person, alive or dead, who has (or had) sudden onset of high fever and had contact with a person with a suspected, probable, or confirmed Ebola case or with a dead or sick animal; any person with sudden onset of high fever and at least three of the following symptoms: headache, vomiting, anorexia or loss of appetite, diarrhea, lethargy, stomach pain, aching muscles or joints, difficulty swallowing, breathing difficulties, or hiccupping; or any person who had unexplained bleeding or who died suddenly from an unexplained cause. A probable case is illness in any person suspected to have EVD who was evaluated by a clinician or any person who died from suspected Ebola and had an epidemiologic link to a person with a confirmed case but was not tested and did not have laboratory confirmation of the disease. A probable or suspected case was classified as confirmed when a sample from the person was positive for Ebola virus in laboratory testing." (p. 1486)

<br>
<br>

##  Epidemiologic Curves

<br>
<br>

```{r epicurve_setup, include = FALSE}

# Create a summary tables/dataset which summarises:
# 1. The number of rows for each isoweek 
# 2. The number of rows for each isoweek and status combination
# 3. The number of rows for each isoweek and outcome combination

# 1.
# week_summary <- ebola_df %>%
#   group_by(week) %>% # Group the dataset
#   summarise(n_total = n()) %>% # Total number of rows for each week 
#   ungroup() %>% # Remove groupings from the summary datset
#   complete(week = 1:52, fill = list(n_total = 0)) %>%  # Turn implicit missing values into explicit missings
#   mutate(cum_cases = cumsum(n_total))

  
# # 2. 
week_status_summary <- ebola_df %>%
  group_by(onsetDate, status) %>%
  summarise(n_status = n()) %>%
  ungroup() # %>%
#   complete(week = 1:52, status, fill = (list(n_status = 0))) %>%
#   group_by(status) %>%
#   mutate(cum_cases = cumsum(n_status))
# 
# # 3. 
week_outcome_summary <- ebola_df %>%
  group_by(onsetDate, outcome) %>%
  summarise(n_outcome = n()) %>%
  ungroup() # %>%
#   complete(week = 1:52, outcome,  fill = (list(n_outcome = 0))) %>%
#   group_by(outcome) %>%
#   mutate(cum_cases = cumsum(n_outcome))

```

<br>

```{r epicurve_overall}

# curve_total <- week_summary %>%
#   ggplot(aes(x = week)) +
#   geom_col(aes(y = n_total), 
#            fill = "lightseagreen",
#            color = "white") +
#   labs(x = "Epidemiological Week 2019",
#        y = "Number of Cases") +
#   theme_bw() 
# 
# curve_total

```


```{r epicumcurve_overall}

# curve_cum <- week_summary %>%
#   ggplot(aes(x = week, y = cum_cases)) +
#   geom_point() +
#   geom_line(color = "lightseagreen") +
#   labs(x = "Epidemiological Week 2019",
#        y = "Cumulative Number of Cases") +
#   theme_bw() 
# 
# curve_cum

```


```{r epicurve_status}

curve_status <- week_status_summary %>%
  ggplot(aes(x = onsetDate, fill = status)) +
  stat_bin(binwidth = 7, color = "white") +
  scale_x_date(breaks = date_breaks("1 month"), labels = date_format("%b %y")) +
  scale_fill_grey() +
  labs(x = "Date",
       y = "Number of Cases",
       fill = "Case Definitions") +
  theme_bw() 

curve_status



```

<br>

**Figure 1: Weekly incidence by case definition**

<br>

Overall, in the first two months of the epidemic case counts remained under four per week (Figure 1). From November, there was a marked increase in the number of new cases, with case counts peaking in mid-January. Thereafter, the number of cases fell to only three per week.The vast majority of cases are probable or confirmed with laboratory tests. In the most recent weeks, there are a few suspected cases because there has not been an opportunity for physicians to provide clinical diagnoses or lab confirmation yet. 

<br>
 
```{r epicurve_outcome}
curve_outcome <- week_outcome_summary %>%
  ggplot(aes(x = onsetDate, fill = outcome)) +
  stat_bin(binwidth = 7, color = "white") +
  scale_x_date(breaks = date_breaks("1 month"), labels = date_format("%b %y")) +
  scale_fill_grey() +
  labs(x = "Date",
       y = "Number of Cases",
       fill = "Outcome") +
  theme_bw() 


curve_outcome
```

<br>

**Figure 2: Weekly incidence by case outcome**

<br>

Early on in the epidemic, a large proportion of the cases seem to die, while later in the epidemic more cases appear to be recovered or still ill. 

<br>


## Case Fatality 
 
```{r cfr_setup, include = FALSE}

# Create summary data that 
# 1. Counts the cases by case definition
# 2. Counts the deaths by case definition
# 3. Calculates the case fatality ratio by case definition

cases <- ebola_df %>%
 count(status)
  
cases

deaths <- ebola_df %>%
  count(status, outcome, name = "n_deaths") %>%
  filter(outcome == "Died") %>%
  select(-outcome)
  
deaths

cfrs <- cases %>%
  left_join(deaths, by = "status") %>%
  mutate(cfr = format(round((n_deaths / n) * 100, 1), nsmall = 1)) 

overall_deaths <- sum(deaths$n_deaths) 
overall_cf <- overall_cf <- round((overall_deaths / total_cases) * 100, 1)
```

```{r cfr_table}

cfrs %>%
  htmlTable(ctable = TRUE,
            header = c("&nbsp;&nbsp; Case Definition &nbsp;&nbsp;", 
                       "&nbsp;&nbsp; Cases &nbsp;&nbsp;", 
                       "&nbsp;&nbsp; Deaths &nbsp;&nbsp;", 
                       "&nbsp;&nbsp; Case Fatality Ratio (%) &nbsp;&nbsp;"),
            rnames = FALSE,
            caption = "<b>Case Fatality Ratios (CFR) by case definition<b>",
            align = "l|rrr",
            css.cell = "padding-left: .5em; padding-right: .5em;")

```

<br>

Overall, there were  `r overall_deaths` (`r overall_cf` %) deaths in the population. Table 1 presents CRFs by case definition. Cases that were classified as probable had the highest CRF, with 100% of cases dying. 

<br>

## Growth Curve and Basic Reproduction Number
An exponential growth curve was fitted to the weekly incidence data and estimates
of the reproductive number were derived. The basic reproductive number, denoted Ro, is a measure
of the infectivity of a single case in a completely susceptible population and it
can be used to predict if an outbreak will occur. The reproductive number, denoted 
R(t) is a measure of infectivity of a single case in a population where some
members have already been exposed to infection. 

<br>

```{r epi_analysis1}
# - Fitting the incidence curve
library('ggplot2');library('magrittr')
ebola.incidence=incidence(ebola_df$onsetDate,interval = 'weeks',standard = F)
# Fitting
ebola.incidence.fit=fit(ebola.incidence)
my_theme <- theme_bw(base_size = 12) +
  theme(panel.grid.minor = element_blank()) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5, color = "black"))
plot(ebola.incidence, ylab='Weekly incidence',border = "white") %>% 
  add_incidence_fit(ebola.incidence.fit) +
  labs(title='Weekly incidence from data and model fit') + 
  my_theme
```

<br>

**Figure 7: Weekly incidence over the 3-month reporting period.** The grey bars show the reported
data while the lines show the model predictions and 95% confidence intervals(dashed lines)

<br>

The estimated daily growth rate is `r ebola.incidence.fit$info$r` (`r ebola.incidence.fit$info$r.conf[1]`, 
`r ebola.incidence.fit$info$r.conf[2]`). The stimated time it would take for the epidemic
to double in size is `r signif(ebola.incidence.fit$info$doubling,3)` (`r signif(ebola.incidence.fit$info$doubling.conf[1],3)`, 
`r signif(ebola.incidence.fit$info$doubling.conf[2],3)`) days. 

```{r epi_analysis2}
# # - Compute Ro and R(t)
# 
# weeks.strt=seq(1,98,7)
# weeks.end=seq(7,98,7)
# week.date=seq(min(ebola_df$onsetDate),max(ebola_df$onsetDate),7)
# 
# # Ro
# ebola.GT<-generation.time("gamma", c(15.3,9.3))
# temp=table(ebola_df$onsetDate)
# ebola.inc=as.numeric(temp);names(ebola.inc)=names(temp);rm(temp)
# estR0<-estimate.R(ebola.inc, ebola.GT,methods=c("EG"))
# # R(t)
# estRt<-estimate.R(ebola.inc, ebola.GT,methods=c("TD"),begin=1, end=98, nsim=100)
# estRt.weekly <-smooth.Rt(estRt$estimates$TD, 7)
# 
# plot.estRt.weekly=data.frame(date=week.date,
#                              est=estRt.weekly$R,lwr=estRt.weekly$conf.int[,1],
#                              upr=estRt.weekly$conf.int[,2])
# ggplot(plot.estRt.weekly,aes(x = date,y = est)) + geom_line(size=1) +
#   labs(title='Estimated weekly reproductive number and confidence intervals',x="Time",y = "R(t)") + my_theme + 
# geom_line(aes(x= date,y = lwr), color = "red", linetype = "dotted",size=1) +
#   geom_line(aes(x= date,y = upr), color = "red", linetype = "dotted",size=1) +
#   geom_hline(yintercept=1, linetype="dashed", color = "grey", size=1)

```
<br>

**Figure 8: Estimates of the weekly reproductive number over time.** The black line shows the 
median estimate while the dotted red lines show the 95% confidence interval. The 
dashed grey line shows 1.

<br>

The reproductive number over time shown in the previous figure is consistently estimated 
to be above 1 up until the last week. However, this dip in the last week should be interpreted
with caution as the confidence interval is very wide. The basic reproductive number [INSERT NEW CODE HERE]

<br>
<br>

## Waiting time between symptom onset and case reporting
<br>
The time between when symptoms begin and when a case is reported might change as 
the outbreak progresses, which might be an indicator of community awareness. The
average weekly waiting time is plotted against epidemic week in the figure below.
<br>
<br>
```{r epi_analysis3}
# # - Time between onset and reporting
# waiting.period=data.frame(day=as.numeric(ebola_df$reportDate-min(ebola_df$reportDate)+1),
#                           wait=as.numeric(ebola_df$reportDate-ebola_df$onsetDate))
# # Average weekly waiting period
# weekly.waiting.period=data.frame(start=week.date,ave.wait=0)
# for(w in 1:length(week.date)){
#   x=which((waiting.period$day>=weeks.strt[w]) & (waiting.period$day<=weeks.end[w]))
#   weekly.waiting.period$ave.wait[w]=sum(waiting.period$wait[x])/length(x)
# }
# ggplot(weekly.waiting.period,aes(x = start,y = ave.wait)) + geom_line() +
#   labs(title='Average weekly waiting period between onset and reporting',x="Time", 
#        y = "Average waiting period in days") + my_theme

```
<br>
**Figure 9: Average weekly waiting time.**
<br>
<br>
The time it takes for a case to be reported given symptom onset does not seem to 
change much over the course of the outbreak thus far. However, this could be dependent on
the definition of symptoms, additional data would be need to better capture changing
behavioural dynamics. 

<br>
<br>

# **References**
